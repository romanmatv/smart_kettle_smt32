# Smart Kettle on smt32

Проект умного термопота на stm32 Arduino.
Атэншен! Код максимально не оптимален, крив и полон костылей. Проект изначально разрабатывался для Arduino nano, однако ее RAM не хватало для работы OneButton, датчика температуры и SPI экранчика. А так же у нее просто уже заканчивались контакты.

STM32 была приведина на Arduino просто потому что так было проще и быстрее, не исключаю, что в специализированных средах для нее можно сделать все на много лучше.

Проект stm32 arduino шорош, но не совсем. Эмуляция EEPROM не работает, при отключении питания все данные забываются.


###### Используемое железо
* МК STM32F103C8T6
* Термодатчик MK00241 типа DS18B20
* Дисплэй SSD1306 (SPI)
* Модуль реального времени DS1302
* 3 модуля реле Low level
* Поплавок ESC7810
* DC-DC преобразователь с 12 на 5 вольт
* Сам термопот с двойным тэном (слабый и мощный), помпой и двумя кнопками
* БП на 12 вольт
* Подтягивающий ризистор (10кОм) для попловка на землю
* Резистор (4,7кОм) для датчика температуры

###### Сторонние библиотеки
* Arduino STM32 (https://github.com/rogerclarkmelbourne/Arduino_STM32)
* Adafruit GFX Library (https://github.com/adafruit/Adafruit-GFX-Library)
* Adafruit_SSD1306 (https://github.com/adafruit/Adafruit_SSD1306)
* OneButton (https://github.com/mathertel/OneButton)
* DS1302 RTC (https://github.com/msparks/arduino-ds1302)

###### Сборка
Все используемые параметры и пины выведены в отдельные переменные, что упрощает настройку под себя, а так же поиск того, что на какой пин вешать.

###### Команды
Поддерживается ряд команд для общения по серийному порту, планируется подключение по блютуз, но пока нет такой возможности.
*`settime;201801031309003` - установка времени в формате ГОДмесяцДЕНЬчасМИНУТЫсекундыДЕНЬНЕДЕЛИ
  Например 201801031309003, что эквивалентно 2018-01-03 13:09:00 Среда
*`gettime;` - получить время, формат вывода `Wednesday 2018-01-10 23:56:36`.
*`getstatus;` - получить текущий статус с температурой, формат `1;88.65`. 
 Статусы:
  *0 Отключен
  *1 Поддержка температуры
  *2 Кипичение
  *3 Нет воды
  *4 Сильный перегрев
*`setforce;a` - значение a: 0 - работа по расписанию, 1 - принидительно вкл, 2 - принудительно выкл.
*`getforce;` - получить текущее значение принудительных переключателей, значения описаны пунктом выше
*`addshudle;a,b,c,d,e;` - добавить новый промежуток в расписание.
 *a - номер дня недели, если значение более 7 значит объект считается неактивным. По дэфолту значение неактивности 200
 *b - час старта
 *c - минуты старта
 *d - час остановки
 *e - минуты остановки
*`updshudle;a,b,c,d,e;...;a,b,c,d,e;` - обновление всего расписания. Передается 100 объектов расписания. Формат аналогичен предыдущему пункту
*`getshudle;` - получить расписание. Выдается все 100 объектов расписания. Формат аналогичен.
*`getsettings;` - получить текущие настройки. Формат `Температура_поддержания;Темп_минус;Темп_плюс;Кипячен_по_включению;Секунд_кипячения;Кипячение_при_перепаде`
*`setsettings;aabcdeef` - установить настройки.
 *aa - две цифры, значение температуры для поддержания
 *b - одна цифра, нижняя граница поддерживаемой температуры
 *c - одна цифра, верхняя граница поддерживаемой температуры
 *d - одна цифра, 0 или 1, кипячение при старте (пока не актуально, EEPROM не работает)
 *ee - две цифры, колличество секунд кипичения
 *f - одна цифра, 0 или 1, кипячение при перепаде температуры
*`boiling;` - включить кипячение
